---
- name: Set modules
  copy: 
    dest: /mnt/etc/mkinitcpio.conf
    force: yes
    content: |
      MODULES=(hv_storvsc hv_vmbus hv_netvsc zram)
      BINARIES=()
      FILES=()
      HOOKS=(systemd systemd-tool autodetect microcode modconf kms keyboard sd-vconsole block luks_unlocker sd-encrypt filesystems)
      COMPRESSION="zstd"
      COMPRESSION_OPTIONS=(-9)

- name: Set modules for fallback
  copy: 
    dest: /mnt/etc/mkinitcpio-fallback.conf
    force: yes
    content: |
      MODULES=(hv_storvsc hv_vmbus hv_netvsc zram)
      BINARIES=()
      FILES=()
      HOOKS=(systemd systemd-tool autodetect microcode modconf kms keyboard sd-vconsole block sd-encrypt filesystems)
      COMPRESSION="zstd"
      COMPRESSION_OPTIONS=(-9)

- name: Create /etc/cmdline.d directory
  ansible.builtin.file:
    path: /mnt/etc/cmdline.d
    state: directory

- name: Create /etc/cmdline.d directory
  ansible.builtin.file:
    path: /mnt/etc/cmdline.d/default
    state: directory

- name: Create /etc/cmdline.d directory
  ansible.builtin.file:
    path: /mnt/etc/cmdline.d/fallback
    state: directory

- name: Get the UUID of the LUKS partition at {{ install_device_name }}{{ root_partition_number }}
  command: blkid -s UUID -o value {{ install_device_name }}{{ root_partition_number }}
  register: luks_partition_uuid

- name: set cmdline root conf for UKI
  copy:
    owner: root
    group: root
    force: yes
    dest: /mnt/etc/cmdline.d/default/root.conf
    content: |
      root=/dev/mapper/{{ luks_root_name }} rootflags=subvol=@ rw rd.neednet=1 console=tty0 console=ttyS0,115200 bgrt_disable lsm=landlock,lockdown,yama,integrity,apparmor,bpf slab_nomerge init_on_alloc=1 init_on_free=1 page_alloc.shuffle=1 pti=on randomize_kstack_offset=on vsyscall=none debugfs=off oops=panic intel_iommu=on amd_iommu=on

- name: set cmdline fallback conf for UKI
  copy:
    owner: root
    group: root
    force: yes
    dest: /mnt/etc/cmdline.d/fallback/root.conf
    content: |
      rd.luks.name={{ luks_partition_uuid.stdout }}={{ luks_root_name }} root=/dev/mapper/{{ luks_root_name }} rootflags=subvol=@ rw rd.neednet=1 console=tty0 console=ttyS0,115200 bgrt_disable lsm=landlock,lockdown,yama,integrity,apparmor,bpf slab_nomerge init_on_alloc=1 init_on_free=1 page_alloc.shuffle=1 pti=on randomize_kstack_offset=on vsyscall=none debugfs=off oops=panic intel_iommu=on amd_iommu=on

- name: Create systemd-networkd config directory
  ansible.builtin.file:
    path: /mnt/etc/systemd/network
    state: directory

- name: Configure initrd network (DHCP)
  copy:
    owner: root
    group: root
    force: yes
    dest: /mnt/etc/systemd/network/20-wired.network
    content: |
      [Match]
      Name=en* eth*

      [Network]
      DHCP=yes

- name: set /etc/mkinitcpio.d/{{ kernel }}.preset
  copy:
    owner: root
    group: root
    force: yes
    dest: /mnt/etc/mkinitcpio.d/{{ kernel }}.preset
    content: |
      ALL_kver="/boot/vmlinuz-{{ kernel }}"
      PRESETS=('default' 'fallback')
      default_uki="/efi/EFI/Linux/arch-linux.efi"
      default_config="/etc/mkinitcpio.conf"
      default_options="--cmdline /etc/cmdline.d/default/root.conf"
      fallback_uki="/efi/EFI/Linux/arch-linux-fallback.efi"
      fallback_options="--cmdline /etc/cmdline.d/fallback/root.conf -S autodetect"
      fallback_config="/etc/mkinitcpio-fallback.conf"

- name: Set luks_unlocker install
  copy: 
    dest: /mnt/etc/initcpio/install/luks_unlocker
    force: yes
    content: |
      #!/bin/bash

      build() {
          add_binary /usr/local/bin/luks_unlocker /usr/local/bin/luks_unlocker
          add_systemd_unit luks_unlocker.service
          add_systemd_unit network-online.target
          add_systemd_unit cryptsetup-pre.target
          add_systemd_unit systemd-networkd-wait-online.service
          cd "$BUILDROOT/usr/lib/systemd/system/sysinit.target.wants"
              ln -sf ../cryptsetup-pre.target cryptsetup-pre.target
              ln -sf ../luks_unlocker.service luks_unlocker.service
              ln -sf ../network-online.target network-online.target
              ln -sf ../systemd-networkd-wait-online.service systemd-networkd-wait-online.service
      }

      help() {
          cat <<HELPEOF
      This hook will attempt to decrypt the luks encryption.
      HELPEOF
      }

- name: Ensure /etc/initcpio/install/luks_unlocker
  file:
    path: /mnt/etc/initcpio/install/luks_unlocker
    mode: '0755'


- name: Set luks_unlocker install
  copy: 
    dest: /mnt/usr/lib/systemd/system/luks_unlocker.service
    force: yes
    content: |
      [Unit]
      Description=Unlock LUKS with KeyVault
      Before=cryptsetup-pre.target
      DefaultDependencies=no
      Wants=network-online.target
      After=network-online.target systemd-networkd-wait-online.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStartPre=/bin/sh -c 'echo "nameserver 168.63.129.16" > /etc/resolv.conf'
      ExecStart=/bin/sh -c '/usr/lib/systemd/systemd-cryptsetup attach {{ luks_root_name }} /dev/disk/by-uuid/{{ luks_partition_uuid.stdout }} - tpm2-device=auto || /usr/local/bin/luks_unlocker'
      Restart=on-failure           
      RestartSec=10s                
      StartLimitIntervalSec=60s    
      StartLimitBurst=6
      StandardError=journal+console
      StandardOutput=journal+console

      [Install]
      WantedBy=cryptsetup-pre.target

- name: Download luks_unlocker zip
  get_url:
    url: https://github.com/mgugger/azure-keyvault-unlock-luks/releases/download/v0.0.1/azure-keyvault-unlock-luks_x86_64.zip
    dest: /tmp/luks_unlocker.zip

- name: Unpack luks_unlocker zip
  unarchive:
    src: /tmp/luks_unlocker.zip
    dest: /mnt/usr/local/bin
    remote_src: yes

- name: Ensure luks_unlocker is executable
  file:
    path: /mnt/usr/local/bin/luks_unlocker
    mode: '0755'

- name: Install first-boot TPM enroll service
  copy:
    dest: /mnt/etc/systemd/system/enroll-tpm.service
    force: yes
    content: |
      [Unit]
      Description=Enroll TPM2 key for LUKS
      ConditionFirstBoot=yes

      [Service]
      Type=oneshot
      ExecStart=/usr/bin/systemd-cryptenroll --tpm2-device=auto /dev/disk/by-uuid/{{ luks_partition_uuid.stdout }}

      [Install]
      WantedBy=multi-user.target

- name: Enable first-boot TPM enroll service
  command:
    argv:
      - /usr/bin/systemctl
      - --root=/mnt
      - enable
      - enroll-tpm.service

- name: Write /etc/kernel/uki.conf
  copy:
    owner: root
    group: root
    force: yes
    dest: /mnt/etc/kernel/uki.conf
    content: |
      [UKI]
      SecureBootPrivateKey=/etc/kernel/secure-boot-private-key.pem
      SecureBootCertificate=/etc/kernel/secure-boot-certificate.pem

- name: Ensure /etc/initrd-release exists
  ansible.builtin.file:
    path: /mnt/etc/initrd-release
    state: touch

- name: Configure System
  command:
    argv:
      - /usr/bin/arch-chroot
      - /mnt
      - /bin/bash
      - -c
      - |
        pacman -S --noconfirm systemd-ukify mkinitcpio-systemd-tool
        systemctl --root=/mnt enable initrd-network.service
        ln -sf /usr/share/zoneinfo/CET /etc/localtime
        hwclock --systohc
        locale-gen
        echo -e "{{root_pw}}\n{{root_pw}}" | passwd
        mkdir -p /efi/EFI/Linux
        mkinitcpio -P {{ kernel }} || true
        mkdir -p /etc/kernel
        ukify genkey --config /etc/kernel/uki.conf
        /usr/lib/systemd/systemd-sbsign sign \
          --private-key /etc/kernel/secure-boot-private-key.pem \
          --certificate /etc/kernel/secure-boot-certificate.pem \
          --output /usr/lib/systemd/boot/efi/systemd-bootx64.efi.signed \
          /usr/lib/systemd/boot/efi/systemd-bootx64.efi
        bootctl install --secure-boot-auto-enroll yes \
          --certificate /etc/kernel/secure-boot-certificate.pem \
          --private-key /etc/kernel/secure-boot-private-key.pem

- name: Export Secure Boot db certificate for build output
  command:
    argv:
      - /usr/bin/cp
      - /mnt/etc/kernel/secure-boot-certificate.pem
      - /tmp/secureboot-cert.pem

- name: Create pacman hooks directory for Secure Boot
  ansible.builtin.file:
    path: /mnt/etc/pacman.d/hooks
    state: directory

- name: Install secure boot resign script
  copy:
    owner: root
    group: root
    force: yes
    dest: /mnt/usr/local/bin/secure-boot-resign
    mode: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      /usr/bin/mkinitcpio -P {{ kernel }}
      /usr/lib/systemd/systemd-sbsign sign \
        --private-key /etc/kernel/secure-boot-private-key.pem \
        --certificate /etc/kernel/secure-boot-certificate.pem \
        --output /usr/lib/systemd/boot/efi/systemd-bootx64.efi.signed \
        /usr/lib/systemd/boot/efi/systemd-bootx64.efi

- name: Add pacman hook to resign boot artifacts
  copy:
    owner: root
    group: root
    force: yes
    dest: /mnt/etc/pacman.d/hooks/90-sbctl-resign.hook
    content: |
      [Trigger]
      Operation = Install
      Operation = Upgrade
      Type = Package
      Target = {{ kernel }}
      Target = mkinitcpio
      Target = systemd
      Target = systemd-boot

      [Action]
      Description = Regenerate UKIs and sign systemd-boot
      When = PostTransaction
      Exec = /usr/local/bin/secure-boot-resign

- name: Add pacman hook to re-enroll TPM after kernel changes
  copy:
    owner: root
    group: root
    force: yes
    dest: /mnt/etc/pacman.d/hooks/95-tpm2-reenroll.hook
    content: |
      [Trigger]
      Operation = Install
      Operation = Upgrade
      Type = Package
      Target = {{ kernel }}
      Target = mkinitcpio
      Target = systemd
      Target = systemd-boot

      [Action]
      Description = Re-enroll TPM2 key for LUKS
      When = PostTransaction
      Exec = /usr/bin/systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=7+11 /dev/disk/by-uuid/{{ luks_partition_uuid.stdout }}

- name: Fail if /mnt/usr/lib/initcpio/install/systemd-tool does not exist
  stat:
    path: /mnt/usr/lib/initcpio/install/systemd-tool
  register: systemd_tool_file

- name: Check if systemd-tool hook exists
  fail:
    msg: "/mnt/usr/lib/initcpio/install/systemd-tool does not exist"
  when: not systemd_tool_file.stat.exists